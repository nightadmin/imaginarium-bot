# Imaginarium Game
Реализация игры "Имаджинариум" в формате чат-бота на VK API.
## Установка
По непонятным причинам некоторые команды бота на серверах Linux имеют проблемы с кодировкой, но на Windows 10 все ок.
Тем не менее, запуск на Linux также возможен.
```bash
git clone https://github.com/nightadmin/imaginarium-game
cd imaginarium-game
```
Далее в конфиге config.json правим id паблика, токен паблика для longpoll, а также токен пользователя с правами photos.
В поле allowed можно вписать свой id, и вы получите доступ к некоторым админским командам (например, я сделал удобную утилиту для собственной настройки меток на картинках для задания на 20 баллов).
Если вы запускаете на Linux, имеет смысл добавить строчку
```python
import os
os.chdir("path/to/bot")
```
, чтобы не иметь проблем с чтением файлов.
Теперь можно установить MongoDB:
```bash
sudo apt install mongodb-org
mongod --port 3001 &
```
Осталось подтянуть python-модули:
```bash
pip3 install pymongo
pip3 install vk_api
```
Можно запускать!
```bash
python3 main.py
```
## Что это такое
Это бот с возможностью создавать свои команды, добавлять туда людей по инвайт-коду, исключать конкретных людей и разформировывать команду. В команде можно смотреть результаты участников, при этом результаты удаленных участников не удаляются, а помечаются плашкой "исключен", что позволяет видеть полную статистику.
Есть одиночная игра (вызывается командой **на баллы**) с выбором источника картинок (заданный датасет, этот же датасет с нашими подписями, которые мы заставили расставлять фронтендера прошлой ночью и альбом VK). Выдается 5 картинок (в коде можно менять количество), и одно ключевое слово (гарантируется, что оно применимо только к одному изображению). Задача - отгадать и нажать на номер картинки. За правильный ответ дают 3 балла.
PS! Все это работает и в мультиплеере!
Также технически все готово к реализации игры с ведущим (на это даже можно найти ссылки в документах БД), но опять таки сделать все до конца я не успел.
## Команды
* **старт** - выдать 5 случайных картинок из дефолтного датасета
* **начать\хелп\помощь** - приветственное сообщение
* **на баллы** - запуск одиночной игры на баллы с выбором источника
* создать команду [имя] (необязательный параметр) - создание команды и показ инвайт-кода
* присоединиться к [инвайт] - присоединиться к команде
* покинуть команду - все очевидно
* расформировать команду - удалить команду и кикнуть всех ее участников.
## Утилита для переразметки (плохо работает с Linux)
* настройка подписей локальных изображений - собственно, старт процесса. Бот проигнорует команду от человека, которого нет в allowed-листе конфига
* <...> - остальные команды висят на кнопочках
Есть возможность пойти и отдохнуть пару часиков - бот хранит админские сессии и их прогресс в базе данных.
## Как это работает?
### Архитектура БД
Есть две коллекции - teams и teams_values (в MongoDB она users).
Оюъекты teams выглядят примерно так:
![team](https://i.ibb.co/F0V6XD3/image.png)
Поясню самое важное:
- game_state - текущее состояние игры. Там есть поле active - начата ли игра, а также users_state - перечисление всех когда-либо бывших людей в этой команде и их очки.
- personal - является ли игра одиночной. В частности, чтобы покинуть одиночную игру не требуется предупреждения.
- source (default, another, remote) - источник картинок. Если remote, то есть дополнительное поле с ссылкой на альбом.
- mode - тип игры (oneplayer, multiplayer, multiplayer+) - собственно, одиночная игра, мультиплеер или мультиплеер с ведущим. Вы могли заметить, что задание на 10 баллов (команда "старт") не реализована в виде игры - потому что она была создана гораздо раньше teams-коллекции да и просто неуместна в виде документа команды - коллекция команд была создана для учета очков, а тут их нет.
Объекты teams_values это технические документы, которые соответствуют каждой команде или игроку и указывают, какие изображения исключены из списков - это список индексов в 1 задании и строки вида photo-123_456 в последующих.
Они быстро вычитаются благодаря использованию множеств set.
